---
title: "Calculate General Indicators Flanders Case Study WP6"
output: html_document

---
#install packages
```{r}
#install.packages("b3gbi", repos = c("https://b-cubed-eu.r-universe.dev", "https://cloud.r-project.org"))

gc()
library(b3gbi)
library(sf)
library(taxize)
```

#read in Angiosperm data
```{r}
Angiosperm_data_cube <- process_cube(read.csv('./data/raw/Angiosperm_data.csv'))

Angiosperm_data_cube 

str(Angiosperm_data_cube)
```

```{r}
Flanders <- read_sf('./data/spatial/flanders_wgs84.geojson')
```

#Running b3gbi indicators
##8.1. Observed Species Richness ~ recorded richness
```{r}
'This fundamental indicator quantifies the total number of unique species detected within a given spatial unit (e.g., grid cell, for indicator_map) or temporal period (e.g., year, for indicator_ts). It provides a straightforward measure of detected biodiversity.'

#TODO: lukt niet om schaal aan te passen naar 1 km
OSR_map <- obs_richness_map(Angiosperm_data_cube,
                            level = "country", 
                            region = "Belgium",
                            shapefile_path = './data/spatial/Flanders.shp')

saveRDS(OSR_map, 
        './data/output/general_indicators/OSR_map.rds')

OSR_ts <- obs_richness_ts(Angiosperm_data_cube, 
                          level = "country", 
                          region = "Belgium",
                          shapefile_path = './data/spatial/Flanders.shp')

saveRDS(OSR_ts, 
        './data/output/general_indicators/OSR_ts.rds')

```

##8.2. Total Occurrences
```{r}
'This variable quantifies the overall number of species occurrence records within a spatial unit or temporal period. While not a biodiversity indicator itself, it is crucial for understanding data comprehensiveness and distribution. It is presented as a map showing data density or a time series of annual record counts.'

gc()

#TODO: lukt niet om schaal aan te passen naar 1 km
TO_map <- total_occ_map(Angiosperm_data_cube,
                            level = "country", 
                            region = "Belgium", 
                          shapefile_path = './data/spatial/Flanders.shp')



#TODO;check dat NA buiten Vlaanderen resultaat niet beïnvloedt?
TO_ts <- total_occ_ts(Angiosperm_data_cube, 
                          level = "country", 
                          region = "Belgium",
                          shapefile_path = './data/spatial/Flanders.shp')

saveRDS(TO_map, 
        './data/output/general_indicators/TO_map.rds')

saveRDS(TO_ts, 
        './data/output/general_indicators/TO_ts.rds')



#Bootstrapping ok
```

#8.3. Evenness
```{r}
"Evenness measures how uniformly individuals (or observations in GBIF data) are distributed among species within a given area or over time. It complements species richness by providing insight into community structure. b3gbi supports Pielou's Evenness and Williams' Evenness, displaying their values spatially on maps (indicator_map) or as trends over time (indicator_ts)."

#bootstrapping ok

gc()

PEM_map <-  pielou_evenness_map(Angiosperm_data_cube,
                            level = "country", 
                            region = "Belgium", 
                            shapefile_path = './data/spatial/Flanders.shp')

PEM_map_plot <- plot(PEM_map)

WEM_map <- williams_evenness_map(Angiosperm_data_cube,
                            level = "country", 
                            region = "Belgium", 
                            shapefile_path = './data/spatial/Flanders.shp')

WEM_map_plot <- plot(WEM_map)

PEM_ts <-  pielou_evenness_ts(Angiosperm_data_cube,
                            level = "country", 
                            region = "Belgium", 
                            shapefile_path = './data/spatial/Flanders.shp')

PEM_ts_plot <- plot(PEM_ts)

WEM_ts <- williams_evenness_ts(Angiosperm_data_cube,
                            level = "country", 
                            region = "Belgium", 
                            shapefile_path = './data/spatial/Flanders.shp')

WEM_ts_plot <- plot(WEM_ts)

##export data to showcase in dashboard
saveRDS(PEM_map, 
        './data/output/general_indicators/PEM_map.rds')

saveRDS(PEM_ts, 
        './data/output/general_indicators/PEM_ts.rds')

saveRDS(WEM_map, 
        './data/output/general_indicators/WEM_map.rds')

saveRDS(WEM_ts, 
        './data/output/general_indicators/WEM_ts.rds')


```

#8.4. Rarity
```{r}
"Rarity quantifies the scarcity or infrequency of species, and when summed over multiple species, serves as a crucial biodiversity indicator for conservation. b3gbi offers two distinct measures: Abundance-Based Rarity (based on species' proportional occurrences) and Area-Based Rarity (based on species' spatial occupancy). These can be mapped (indicator_map) to identify areas with a higher presence of rare species, or tracked over time (indicator_ts) to observe changes in overall rarity."

#bootstrapping ok

gc()

ArRM_map <-  area_rarity_map(Angiosperm_data_cube,
                            level = "country", 
                            region = "Belgium", 
                            shapefile_path = './data/spatial/Flanders.shp')

ArRM_map_plot <- plot(ArRM_map)

AbRM_map <- ab_rarity_map(Angiosperm_data_cube,
                            level = "country", 
                            region = "Belgium", 
                            shapefile_path = './data/spatial/Flanders.shp')

AbRM_map_plot <- plot(AbRM_map)

ArRM_ts <-  area_rarity_ts(Angiosperm_data_cube,
                            level = "country", 
                            region = "Belgium", 
                            shapefile_path = './data/spatial/Flanders.shp')

ArRM_ts_plot <- plot(ArRM_ts)

AbRM_ts <- ab_rarity_ts(Angiosperm_data_cube,
                            level = "country", 
                            region = "Belgium", 
                            shapefile_path = './data/spatial/Flanders.shp')

AbRM_ts_plot <- plot(AbRM_ts)

##export data to showcase in dashboard
saveRDS(ArRM_map, 
        './data/output/general_indicators/arRM_map.rds')

saveRDS(ArRM_ts, 
        './data/output/general_indicators/arRM_ts.rds')


saveRDS(AbRM_map, 
        './data/output/general_indicators/abRM_map.rds')

saveRDS(AbRM_ts, 
        './data/output/general_indicators/abRM_ts.rds')

```

#8.5. Estimated Hill Diversity
```{r}
'Hill Diversity provides a unified framework for various diversity measures, allowing for different emphases on rare versus common species through a single parameter, q. b3gbi calculates three common forms: q=0 (approximates Species Richness, weighing all species equally), q=1 (emphasizes common species, like Hill-Shannon), and q=2 (emphasizes very common species, like Hill-Simpson). These indicators represent the "effective number of species" and can be mapped (indicator_map) or tracked over time (indicator_ts) to provide multi-faceted insights into biodiversity patterns.

SR: Species richness - hill0_map() and hill0_ts()

HSh: Hill-Shannon diversity - hill1_map() and hill1_ts()

HSi: Hill-Simpson diversity - hill2_map() and hill2_ts()'

gc()

SR_map <-  hill0_map(Angiosperm_data_cube,
                            level = "country", 
                            region = "Belgium", 
                            shapefile_path = './data/spatial/Flanders.shp')

SR_map_plot <- plot(SR_map)

HSh_map <- hill1_map(Angiosperm_data_cube,
                            level = "country", 
                            region = "Belgium", 
                            shapefile_path = './data/spatial/Flanders.shp')

HSh_map_plot <- plot(HSh_map)

HSi_map <- hill2_map(Angiosperm_data_cube,
                            level = "country", 
                            region = "Belgium", 
                            shapefile_path = './data/spatial/Flanders.shp')

HSi_map_plot <- plot(HSi_map)

SR_ts <-  hill0_ts(Angiosperm_data_cube,
                            level = "country", 
                            region = "Belgium", 
                            shapefile_path = './data/spatial/Flanders.shp')

SR_ts_plot <- plot(SR_ts)

HSh_ts <- hill1_ts(Angiosperm_data_cube,
                            level = "country", 
                            region = "Belgium", 
                            shapefile_path = './data/spatial/Flanders.shp')

HSh_ts_plot <- plot(HSh_ts)

HSi_ts <- hill2_ts(Angiosperm_data_cube,
                            level = "country", 
                            region = "Belgium" , 
                            shapefile_path = './data/spatial/Flanders.shp')

HSi_ts_plot <- plot(HSi_ts)

##export data to showcase in dashboard
saveRDS(SR_map, 
        './data/output/general_indicators/SR_map.rds')

saveRDS(SR_ts, 
        './data/output/general_indicators/SR_ts.rds')


saveRDS(HSh_map, 
        './data/output/general_indicators/HSh_map.rds')

saveRDS(HSh_ts, 
        './data/output/general_indicators/HSh_ts.rds')

saveRDS(HSi_map, 
        './data/output/general_indicators/HSi_map.rds')

saveRDS(HSi_ts, 
        './data/output/general_indicators/HSi_ts.rds')

```

#8.6. Cumulative Species Richness
```{r}
'This indicator tracks the total number of unique species observed from the beginning of a specified time period up to a given year. It provides an estimation of how many new species are still being recorded over time within a region, helping to evaluate sampling effort and assess the overall recorded biodiversity over the study duration. This is an inherently temporal indicator, presented as a time series (indicator_ts).'

gc()

CR_ts <- cum_richness_ts(Angiosperm_data_cube, 
                         level = "country", 
                         region = "Belgium",
                          shapefile_path = './data/spatial/Flanders.shp')

CR_ts_plot <- plot(CR_ts)

##export data to showcase in dashboard

saveRDS(CR_ts, 
        './data/output/general_indicators/CR_ts.rds')

```

#8.7. Mean Year of Occurrence (Newness)
```{r}
'This variable calculates the average year of occurrence for all records within a given spatial unit (e.g., grid cell, for indicator_map) or temporal unit (e.g., year, for indicator_ts), providing an estimation of the relative recency of observations. Maps can highlight areas with more recent average records, while time series show the average observation date over cumulative data.'

#bootstrapping ok

gc()



#TODO: lukt niet om schaal aan te passen naar 1 km
NN_map <- newness_map(Angiosperm_data_cube,
                            level = "country", 
                            region = "Belgium", 
                            shapefile_path = './data/spatial/Flanders.shp')

NN_map_plot <- plot(NN_map)

#TODO;check dat NA buiten Vlaanderen resultaat niet beïnvloedt?
NN_ts <- newness_ts(Angiosperm_data_cube, 
                          level = "country", 
                          region = "Belgium",
                          shapefile_path = './data/spatial/Flanders.shp')
NN_ts_plot <- plot(NN_ts)

##export data to showcase in dashboard
saveRDS(NN_map, 
        './data/output/general_indicators/NN_map.rds')

saveRDS(NN_ts, 
        './data/output/general_indicators/NN_ts.rds')

```

#8.8. Occurrence Density
```{r}
'Occurrence Density measures the spatial concentration of records by calculating the total number of occurrences per square kilometre. This allows for more meaningful comparisons between spatial units of different sizes. It can be displayed as a map (indicator_map) illustrating areas with higher concentrations of records, or as a time series (indicator_ts) showing changes in the rate of recording over time for the study area.'

#bootstrapping ok

gc()

#TODO: lukt niet om schaal aan te passen naar 1 km
OD_map <- occ_density_map(Angiosperm_data_cube,
                            level = "country", 
                            region = "Belgium", 
                            shapefile_path = './data/spatial/Flanders.shp')
OD_map_plot <- plot(OD_map)

#TODO;check dat NA buiten Vlaanderen resultaat niet beïnvloedt?
OD_ts <- occ_density_ts(Angiosperm_data_cube,
                        level = "country", 
                        region = "Belgium", 
                        shapefile_path = './data/spatial/Flanders.shp')
OD_ts_plot <- plot(OD_ts)

##export data to showcase in dashboard
saveRDS(OD_map, 
        './data/output/general_indicators/OD_map.rds')

saveRDS(OD_ts, 
        './data/output/general_indicators/OD_ts.rds')
```

#8.9. Species Occurrences
```{r}
'This variable provides the number of occurrences for individual species, focusing on their observed frequency and distribution. It can serve as a proxy for relative abundance for species with similar detectability. It visualizes the observed geographical distribution of a specific species on a map (indicator_map) or tracks its annual record counts over time (indicator_ts).'

#bootstrapping ok

gc()

#TODO: lukt niet om schaal aan te passen naar 1 km
SO_map <- spec_occ_map(Angiosperm_data_cube,
                            level = "country", 
                            region = "Belgium", 
                            shapefile_path = './data/spatial/Flanders.shp')
SO_map_plot <- plot(SO_map)

#TODO;check dat NA buiten Vlaanderen resultaat niet beïnvloedt?
SO_ts <- spec_occ_ts(Angiosperm_data_cube, 
                     level = "country", 
                     region = "Belgium",
                     shapefile_path = './data/spatial/Flanders.shp')

SO_ts_plot <- plot(SO_ts)

##export data to showcase in dashboard
saveRDS(SO_map, 
        './data/output/general_indicators/SO_map.rds')

saveRDS(SO_ts, 
        './data/output/general_indicators/SO_ts.rds')


```

#8.10. Species Range
```{r}
'Species Range refers to the observed geographical extent of individual species, depicted by the grid cells they occupy. This indicator primarily visualizes the distribution of specific species based on occurrence data, showing occupied cells on a map (indicator_map). Temporally (indicator_ts), it tracks how the number of occupied grid cells for a species changes over time, indicating range expansion, contraction, or stability.'

#bootstrapping ok

gc()

#TODO: lukt niet om schaal aan te passen naar 1 km
SRa_map <- spec_range_map(Angiosperm_data_cube,
                            level = "country", 
                            region = "Belgium", 
                            shapefile_path = './data/spatial/Flanders.shp')
SRa_map_plot <- plot(SRa_map)

#TODO;check dat NA buiten Vlaanderen resultaat niet beïnvloedt?
SRa_ts <- spec_range_ts(Angiosperm_data_cube, 
                        level = "country", 
                        region = "Belgium",
                        shapefile_path = './data/spatial/Flanders.shp')

SRa_ts_plot <- plot(SRa_ts)

##export data to showcase in dashboard
saveRDS(SRa_map, 
        './data/output/general_indicators/SRa_map.rds')

saveRDS(SRa_ts, 
        './data/output/general_indicators/SRa_ts.rds')


```

#8.11. Taxonomic Distinctness
```{r}

'Taxonomic Distinctness measures the average taxonomic distance between any two randomly chosen species in a sample, incorporating their phylogenetic or taxonomic relatedness. A higher value indicates a broader representation of evolutionary history within the community. It can highlight areas on a map (indicator_map) or show trends over time (indicator_ts) where species are, on average, more distantly related.'

gc()

#TODO: lukt niet om schaal aan te passen naar 1 km
TD_map <- tax_distinct_map(Angiosperm_data_cube,
                            level = "country", 
                            region = "Belgium", 
                            shapefile_path = './data/spatial/Flanders.shp')
TD_map_plot <- plot(TD_map)

#TODO;check dat NA buiten Vlaanderen resultaat niet beïnvloedt?
TD_ts <- tax_distinct_ts(Angiosperm_data_cube,
                         level = "country", 
                         region = "Belgium",
                         shapefile_path = './data/spatial/Flanders.shp')

TD_ts_plot <- plot(TD_ts)

##export data to showcase in dashboard
saveRDS(TD_map, 
        './data/output/general_indicators/TD_map.rds')

saveRDS(TD_ts, 
        './data/output/general_indicators/TD_ts.rds')

```

#8.12. Species Turnover -> possibly renamed Occupancy turnover?
```{r}
'Species Turnover measures the rate at which species composition changes over time within a community, quantifying the balance between species "gains" and "losses" between consecutive time intervals. High turnover indicates a dynamic community with frequent species replacement, while low turnover suggests stability. This is an exclusively temporal indicator, presented as a time series (indicator_ts).'


gc()

OT_ts <- occ_turnover_ts(Angiosperm_data_cube,
                         level = "country", 
                         region = "Belgium", 
                         shapefile_path = './data/spatial/Flanders.shp')

OT_ts_plot <- plot(OT_ts)

##export data to showcase in dashboard
saveRDS(OT_ts, 
        './data/output/general_indicators/OT_ts.rds')


```

